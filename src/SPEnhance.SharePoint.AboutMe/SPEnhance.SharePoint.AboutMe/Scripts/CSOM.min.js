(function(){this.SPClient=function(n){var f=this,e=!1,r=0,u=0,t=new SP.ClientContext(n),i=t.get_web().get_lists();this.reInitializeSPClient=function(){t=new SP.ClientContext(n);i=t.get_web().get_lists()};this.getCurrentUserObject=function(n,i,r,u){function e(){$.displayConsoleLog("user.get_title(): "+f.get_title());r(f)}function o(n){$.displayConsoleLog("Failed to get user name. Error:"+n.get_message());u(n)}var f=t.get_web().get_currentUser();t.load(f);i.executeQuery(t).then(e,o)};this.getListData=function(n,r,u,f,e,o,s){function a(){function b(){for(var c=a.getEnumerator(),l=f.split(","),v=[],i,e,s,t,h;c.moveNext();){for(i=c.get_current(),e={},s=0;s<l.length;s++)t=l[s].trim(),y[t]==SP.FieldType.URL?i.get_item(t)!==null?(h={},h[descriptionFieldName]=i.get_item(t).get_description(),h[urlFieldName]=i.get_item(t).get_url(),e[t]=h):e[t]=null:e[t]=i.get_item(t);v.push(e)}o(n,r,v,f,u)}function k(t,i){i!=null&&typeof i!="undefined"&&(h=$.createErrorReason("getListData",i),$.displayConsoleLog(h),s(n,r,i.get_message(),u))}for(var y=[],p=l.getEnumerator(),v,w,i,a;p.moveNext();)v=p.get_current(),w=v.get_fieldTypeKind(),y[v.get_title()]=w;i=new SP.CamlQuery;$.isNullOrEmpty(e)?i=SP.CamlQuery.createAllItemsQuery():i.set_viewXml(e);a=c.getItems(i);f.length>0?t.load(a,"Include("+f+")"):t.load(a);r.executeQuery(t).then(b,k)}function v(t){$.displayConsoleLog("onFailFields: sharePointService.executeQuery on listName: "+u);$.displayConsoleLog("args:"+t);t!=null&&typeof t!="undefined"&&($.displayConsoleLog("args is not null or undefined"),h=$.createErrorReason("getListData.onFailFields",t),$.displayConsoleLog(h),s(n,r,t.get_message(),u))}var h="",c,l;if($.isNullOrEmpty(u)){h='List name "'+u+'" is empty.';$.displayConsoleLog(h);return}c=i.getByTitle(u);l=c.get_fields();t.load(l);$.displayConsoleLog("sharePointService.executeQuery on listName: "+u);r.executeQuery(t).then(a,v);this.isError=function(){return h.length>0?!0:!1};this.errorReason=function(){return h}};this.getListItemCount=function(n,r,u,f,e){function s(){$.displayConsoleLog("Item count for list "+u+" is "+o.get_itemCount());f(o.get_itemCount())}function h(n){$.displayConsoleLog("Failed to get list item count of list "+u+". Error:"+n.get_message());e(n)}var o=i.getByTitle(u);t.load(o);r.executeQuery(t).then(s,h)};this.createOrUpdateListItem=function(n,r,u,f,e,o,s){function y(){o()}function p(n){h=$.createErrorReason("createOrUpdateListItem",n);$.displayConsoleLog(h);$.displayConsoleLog("listName: "+u);$.displayConsoleLog("listItemId: "+f);$.displayConsoleLog("jsonListData:- ");for(var t=0;t<e.data.length;t++)$.displayConsoleLog(e.data[t].fieldName+": "+e.data[t].fieldValue);n!=null&&typeof n!="undefined"&&s(n)}var h,a,v,l,c;if($.displayConsoleLog(e),h="",$.isNullOrEmpty(u)){h='List name "'+u+'" is empty.';$.displayConsoleLog(h);return}for(a=i.getByTitle(u),v=new SP.ListItemCreationInformation,l=f>0?a.getItemById(f):a.addItem(v),c=0;c<e.data.length;c++)l.set_item(e.data[c].fieldName,e.data[c].fieldValue);l.update();t.load(l);r.executeQuery(t).then(y,p);this.isError=function(){return h.length>0?!0:!1};this.errorReason=function(){return h}};this.deleteListData=function(n,r,u,f,e,o){function l(){e(n,r,f)}function a(n){n!=null&&typeof n!="undefined"&&(s=$.createErrorReason("deleteListData",n),$.displayConsoleLog(s),o(n))}var s="",h,c;if($.isNullOrEmpty(u)){s='List name "'+u+'" is empty.';$.displayConsoleLog(s);return}if(f<=0){s='List item Id cannot be "'+f+'"';$.displayConsoleLog(s);return}h=i.getByTitle(u);c=h.getItemById(f);c.deleteObject();r.executeQuery(t).then(l,a);this.isError=function(){return s.length>0?!0:!1};this.errorReason=function(){return s}};this.deleteAllListData=function(n,r,u,f,e){var o="";if($.isNullOrEmpty(u)){o='List name "'+u+'" is empty.';$.displayConsoleLog(o);return}var h=i.getByTitle(u),c=new SP.CamlQuery,s=h.getItems(c);t.load(s,"Include(Id)");r.executeQuery(t).then(function(){function l(){f(n,r,u)}function a(n,t){t!=null&&typeof t!="undefined"&&(o=$.createErrorReason("deleteAllListData",t),$.displayConsoleLog(o),e(t))}for(var h=s.getEnumerator(),i=[],c;h.moveNext();)i.push(h.get_current());for(c in i)i[c].deleteObject();r.executeQuery(t).then(l,a)},function(n){n!=null&&typeof n!="undefined"&&(o=$.createErrorReason("deleteAllListData.GetAllIDs",n),$.displayConsoleLog(o),e(n))})};this.displayAllLists=function(n,r,u,f,e){function o(){for(var r=i.getEnumerator(),t,e=[],o=0;r.moveNext();)(t=r.get_current(),u.indexOf(t.get_title())>=0)||(e[o++]=t.get_title());f(n,e)}function s(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("displayAllLists",n),$.displayConsoleLog(errorMessage),e(n))}$.displayConsoleLog("displayAllLists");t.load(i);r.executeQuery(t).then(o,s)};this.deleteList=function(n,r,u,f,e){function o(){function c(){f(n,u)}function l(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("displayAllLists",n),$.displayConsoleLog(errorMessage),e(n))}for(var s=!1,h=i.getEnumerator(),o;h.moveNext();)if(o=h.get_current(),o.get_title()==u){s=!0;break}s?(o.deleteObject(),r.executeQuery(t).then(c,l)):$.displayConsoleLog("List "+u+" doesn't exist")}function s(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("displayAllLists",n),$.displayConsoleLog(errorMessage),e(n))}$.displayConsoleLog("deleting list "+u);t.load(i);r.executeQuery(t).then(o,s)};this.deleteAllLists=function(n,r,f,e,o){function s(){angular.forEach(f,function(n){function a(){$.displayConsoleLog("List "+h+" deleted");u++;u==f.length&&(e(),u=0)}function v(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("deleteAllLists",n),$.displayConsoleLog(errorMessage),o(n))}for(var c=!1,l=i.getEnumerator(),s,h=n.listName;l.moveNext();)if(s=l.get_current(),s.get_title()==h){c=!0;break}c?(s.deleteObject(),r.executeQuery(t).then(a,v)):(u++,$.displayConsoleLog("List "+h+" doesn't exist in deleteAllList"),u==f.length&&(e(),u=0))})}function h(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("displayAllLists",n),$.displayConsoleLog(errorMessage),o(n))}t.load(i);r.executeQuery(t).then(s,h)};this.createList=function(n,r,u,f,e){function h(){$.displayConsoleLog("List "+u+" created");f(u)}function c(n){$.displayConsoleLog("Failed to create list "+u);n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("createList",n),$.displayConsoleLog(errorMessage),e(n,u))}var o=new SP.ListCreationInformation,s;o.set_title(u);o.set_templateType(SP.ListTemplateType.genericList);s=i.add(o);t.load(s);r.executeQuery(t).then(h,c)};this.createListFields=function(n,r,u,e,o,s,h){function c(){function a(){$.displayConsoleLog("Fields created in List "+u);s(u)}function v(n){$.displayConsoleLog("Failed to create fields in list "+u);n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("createListFields",n),$.displayConsoleLog(errorMessage),h(n,u))}for(var c,l=i.getByTitle(u),f="",n=0;n<e.length;n++)o.indexOf(e[n].fieldInternalName)>=0||(f="<Field  Name='"+e[n].fieldInternalName+"' StaticName='"+e[n].fieldInternalName+"' DisplayName='"+e[n].fieldDisplayName+"' Type='"+e[n].fieldType+"'",e[n].fieldType=="URL"&&(f+=" Format='"+e[n].fieldFormat+"'"),e[n].fieldType=="Note"&&(f+=" NumLines='"+e[n].numLines+"'",f+=" RichText='"+e[n].richText+"'",f+=" Sortable='"+e[n].sortable+"'"),f+=" />",$.displayConsoleLog(f),c=l.get_fields().addFieldAsXml(f,!0,SP.AddFieldOptions.addToDefaultContentType|SP.AddFieldOptions.addFieldInternalNameHint|SP.AddFieldOptions.addFieldToDefaultView),c.update());r.executeQuery(t).then(a,v)}function l(n){$.displayConsoleLog("Could not find list "+u);n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("createListFields",n),$.displayConsoleLog(errorMessage),h(n,u))}f.reInitializeSPClient();t.load(i);r.executeQuery(t).then(c,l)};this.createAllLists=function(n,t,i,u,e,o){angular.forEach(i,function(s){function h(h){function c(){r++;r==i.length&&(e(),r=0)}function l(n){n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("createAllLists",n),o(n))}f.createListFields(n,t,h,s.fields,u,c,l)}function c(n){n.get_message().indexOf("A list, survey, discussion board, or document library with the specified title already exists in this Web site")>=0?(r++,r==i.length&&(e(),r=0)):n!=null&&typeof n!="undefined"&&(errorMessage=$.createErrorReason("createAllLists",n),o(n))}f.createList(n,t,s.listName,h,c)})};this.consoleLog=function(n){e=n;$.displayConsoleLog("console log enabled")};$.displayConsoleLog=function(n){e&&console.log(n)};$.isNullOrEmpty=function(n){switch(n){case null:case"":case typeof this=="undefined":return!0;default:return!1}};$.createErrorReason=function(n,t){var i="Error in function "+n;return(t!=null||typeof t!="undefined")&&(i+=". "+t.get_message()+" "+t.get_stackTrace()),i}}})()